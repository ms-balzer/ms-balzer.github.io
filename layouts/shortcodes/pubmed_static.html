{{- $data := .Site.Data.pubmed -}}

{{- $me1 := "Balzer MS" -}}
{{- $me2 := "S Balzer M" -}}
{{- $placeholder := "/media/pub-placeholder.png" -}}

{{- if not $data -}}
  <span class="pubmed-static-stamp"
        data-pubmed-static="true"
        data-has-data="false"
        style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden;">
    pubmed_static
  </span>

  <p><em>Static publications list not available yet. Generate data/pubmed.json.</em></p>

{{- else -}}
  <span class="pubmed-static-stamp"
        data-pubmed-static="true"
        data-has-data="true"
        data-generated-at="{{ $data.generated_at }}"
        data-count="{{ $data.count }}"
        style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden;">
    pubmed_static
  </span>

  <div class="pub-list">
    {{- range $i, $p := $data.items -}}

      {{- $detail := $p.detail_url | default $p.pubmed_url -}}

      {{/* Thumbnail source: prefer bundle thumb.*; else placeholder */}}
      {{- $thumb_src := $placeholder -}}
      {{- if $p.detail_url -}}
        {{- $slug := (replace (replace $p.detail_url "/publications/" "") "/" "") -}}
        {{- $page := site.GetPage (printf "/publications/%s" $slug) -}}
        {{- if $page -}}
          {{- with $page.Resources.GetMatch "thumb.*" -}}
            {{- $img := .Fit "140x140" -}}
            {{- $thumb_src = $img.RelPermalink -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}

      <div class="pub-item">

        <div class="pub-thumb-col">
          <a class="pub-thumb-link"
             href="{{ $detail }}"
             aria-label="{{ if $p.detail_url }}Open publication page{{ else }}Open PubMed record{{ end }}"
             {{- if not $p.detail_url -}} target="_blank" rel="noopener"{{- end -}}>
            <img class="pub-thumb-img"
                 src="{{ $thumb_src }}"
                 alt="{{ if eq $thumb_src $placeholder }}Publication placeholder image{{ else }}Publication thumbnail{{ end }}"
                 loading="lazy">
          </a>
        </div>

        <div class="pub-meta-col">

          <a class="pub-title"
             href="{{ $detail }}"
             {{- if not $p.detail_url -}} target="_blank" rel="noopener"{{- end -}}>
            {{ $p.title }}
          </a>

          {{- if $p.authors }}
            <div class="pub-authors">
              {{- range $ai, $a := $p.authors -}}
                {{- if gt $ai 0 }}, {{ end -}}
                {{- if or (eq $a $me1) (eq $a $me2) -}}
                  <strong>{{ $a }}</strong>
                {{- else -}}
                  {{ $a }}
                {{- end -}}
              {{- end -}}
            </div>
          {{- end }}

          <div class="pub-venue">
            {{ $p.journal }}
            {{- if $p.pubdate_text }}, {{ $p.pubdate_text }}{{ end }}
            {{- if $p.volume }}; {{ $p.volume }}{{ end }}
            {{- if $p.issue }}({{ $p.issue }}){{ end }}
            {{- if $p.pages }}: {{ $p.pages }}{{ end }}
          </div>

          <div class="pub-links">
            <a href="{{ $p.pubmed_url }}" target="_blank" rel="noopener">PubMed</a>

            {{- if $p.doi_url }}
              <span class="pub-link-sep">|</span>
              <a href="{{ $p.doi_url }}" target="_blank" rel="noopener">DOI</a>
            {{- end }}

            {{- if $p.detail_url }}
              <span class="pub-link-sep">|</span>
              <a href="{{ $p.detail_url }}cite.bib" download>BibTeX</a>

              <span class="pub-link-sep">|</span>
              <a href="{{ $p.detail_url }}cite.ris" download>RIS</a>

              <span class="pub-link-sep">|</span>
              <a href="{{ $p.detail_url }}cite.enw" download>EndNote</a>
            {{- end }}

            {{- if $p.pdf_url }}
              <span class="pub-link-sep">|</span>
              <a href="{{ $p.pdf_url }}" target="_blank" rel="noopener">PDF</a>
            {{- end }}
          </div>

        </div>
      </div>

    {{- end -}}
  </div>
{{- end -}}
