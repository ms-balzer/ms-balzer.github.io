<script>
  (function () {
    const STORAGE_KEY = "hb_cookie_consent_v1";
    const GA_ID = "{{ .Site.Params.ga4_measurement_id }}";

    function loadGA4() {
      if (!GA_ID) return;

      // Load gtag.js only after consent
      const s = document.createElement("script");
      s.async = true;
      s.src = "https://www.googletagmanager.com/gtag/js?id=" + encodeURIComponent(GA_ID);
      document.head.appendChild(s);

      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      window.gtag = window.gtag || gtag;

      gtag('js', new Date());
      gtag('config', GA_ID);
    }

    function applyConsent(consent) {
      localStorage.setItem(STORAGE_KEY, consent);

      if (typeof gtag === "function") {
        gtag('consent', 'update', {
          analytics_storage: consent === "accepted" ? "granted" : "denied",
          ad_storage: "denied",
          ad_user_data: "denied",
          ad_personalization: "denied"
        });
      }

      if (consent === "accepted") {
        loadGA4();
      }

      const el = document.getElementById("cookie-banner");
      if (el) el.remove();
    }

    function showBanner() {
      const banner = document.createElement("div");
      banner.id = "cookie-banner";
      banner.style.cssText = [
        "position:fixed",
        "left:0",
        "right:0",
        "bottom:0",
        "z-index:99999",
        "background:#ffffff",
        "border-top:1px solid rgba(0,0,0,.15)",
        "padding:14px 16px",
        "font-size:14px"
      ].join(";");

      banner.innerHTML = `
        <div style="max-width:980px;margin:0 auto;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
          <div style="line-height:1.35;max-width:720px">
            We use cookies for analytics (Google Analytics 4) to understand website usage and improve the site.
            <a href="/privacy/" style="text-decoration:underline">Learn more</a>.
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="cookie-reject" type="button" style="padding:8px 10px">Reject</button>
            <button id="cookie-accept" type="button" style="padding:8px 10px">Accept</button>
          </div>
        </div>
      `;

      document.body.appendChild(banner);

      document.getElementById("cookie-reject").addEventListener("click", () => applyConsent("rejected"));
      document.getElementById("cookie-accept").addEventListener("click", () => applyConsent("accepted"));
    }

    const saved = localStorage.getItem(STORAGE_KEY);

    if (saved === "accepted") {
      // Grant + load GA immediately on subsequent visits
      if (typeof gtag === "function") {
        gtag('consent', 'update', {
          analytics_storage: "granted",
          ad_storage: "denied",
          ad_user_data: "denied",
          ad_personalization: "denied"
        });
      }
      loadGA4();
      return;
    }

    if (saved === "rejected") {
      // Keep denied
      if (typeof gtag === "function") {
        gtag('consent', 'update', {
          analytics_storage: "denied",
          ad_storage: "denied",
          ad_user_data: "denied",
          ad_personalization: "denied"
        });
      }
      return;
    }

    // No choice yet
    showBanner();
  })();
</script>
