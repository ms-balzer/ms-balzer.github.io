<script>
  (function () {
    // Only run if the container exists
    const mount = document.getElementById("bsky-feed");
    if (!mount) return;

    const handle = mount.getAttribute("data-handle");
    if (!handle) return;

    const LIMIT = 10;

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function atUriToPostUrl(atUri, authorHandle) {
      // at://did/app.bsky.feed.post/<rkey>
      const parts = String(atUri).split("/");
      const rkey = parts[parts.length - 1];
      return `https://bsky.app/profile/${authorHandle}/post/${rkey}`;
    }

    function formatDate(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "2-digit" });
      } catch {
        return "";
      }
    }

    async function run() {
      try {
        mount.textContent = "Loading latest postsâ€¦";

        const url = new URL("https://public.api.bsky.app/xrpc/app.bsky.feed.getAuthorFeed");
        url.searchParams.set("actor", handle);
        url.searchParams.set("limit", String(LIMIT));
        url.searchParams.set("filter", "posts_no_replies");

        const res = await fetch(url.toString(), { headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error("Bluesky API error: " + res.status);

        const data = await res.json();
        const feed = Array.isArray(data.feed) ? data.feed : [];

        if (!feed.length) {
          mount.innerHTML = "<p>No posts found.</p>";
          return;
        }

        const itemsHtml = feed.map(item => {
          const post = item.post || {};
          const author = post.author || {};
          const record = post.record || {};
          const text = record.text || "";
          const createdAt = record.createdAt || "";
          const authorHandle = author.handle || handle;
          const link = atUriToPostUrl(post.uri, authorHandle);

          return `
            <div class="bsky-item">
              <div class="bsky-meta">
                <span class="bsky-date">${escapeHtml(formatDate(createdAt))}</span>
                <a class="bsky-link" href="${link}" target="_blank" rel="noopener">View on Bluesky</a>
              </div>
              <div class="bsky-text">${escapeHtml(text).replaceAll("\n", "<br>")}</div>
            </div>
          `;
        }).join("");

        mount.innerHTML = `<div class="bsky-list">${itemsHtml}</div>`;
      } catch (e) {
        console.error(e);
        mount.innerHTML = `<p>Could not load the Bluesky feed automatically.</p>`;
      }
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", run);
    } else {
      run();
    }
  })();
</script>
